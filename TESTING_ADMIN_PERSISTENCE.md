# Testing Admin Portal Data Persistence

## Overview
All admin functions in the admin portal now persist data directly to the Supabase database. Changes made by the admin are immediately visible to all other users across all devices.

## Step-by-Step Testing Guide

### 1. Login as Admin

1. Go to: https://betnexa.vercel.app
2. Click on "Login"
3. Enter these credentials:
   - **Phone:** `0714945142`
   - **Password:** `4306`
4. Click "Login"
5. You should be redirected to `/muleiadmin` (Admin Portal)

### 2. Test Adding a Game (Persistence Test)

**Verify that added games save to database:**

1. In the Admin Portal, find the **"âš½ Games Management"** tab
2. Click **"+ Add Game"** button
3. Fill in the form:
   - **League:** "Premier League"
   - **Home Team:** "Arsenal FC"
   - **Away Team:** "Chelsea FC"
   - **Home Odds:** 2.5
   - **Draw Odds:** 3.0
   - **Away Odds:** 2.8
   - **Time:** (current time will work)
4. Click **"Add Game"** button
5. You should see:
   - Game appears in the games list
   - Alert: "âœ… Game added successfully!"
6. **Verify persistence:**
   - Refresh the page (F5)
   - The game should STILL be there (proving it was saved to DB)
   - Open the same account on another device/browser
   - The game should be visible there too

### 3. Test Updating Game Score

**Verify that score updates persist:**

1. Find the game you just added in the games list
2. Click **"â–¶ï¸ Start Kickoff"** button
3. The game status should change to "LIVE"
4. You should see input fields appear for:
   - **Home Score:**
   - **Away Score:**
5. Enter some scores:
   - Home: 2
   - Away: 1
6. Click **"ðŸ“Š Update Score"** button
7. Verify:
   - Scores appear in the games list
   - Odds automatically adjust based on the score
   - Refresh the page - scores are still there
   - Check on another browser/device - scores are visible

### 4. Test Updating Game Markets

**Verify that market odds persist:**

1. Find a game in the list
2. Click **"âš™ï¸ Edit Markets"** button
3. You should see all available betting markets:
   - BTTS Yes/No
   - Over/Under 1.5, 2.5 goals
   - Double Chance options
   - HT/FT combinations
   - Correct Score options
4. Click on a market odds value to edit it
5. Change a value, e.g., "Over 2.5" from 1.8 to 1.9
6. Click **"ðŸ’¾ Save Markets"** button
7. Alert: "âœ… Markets updated successfully!"
8. Verify:
   - Value updates in the UI
   - Refresh page - value persists
   - Check another browser/device - value is visible

### 5. Test Regenerating Odds

**Verify autogenerated odds persist:**

1. Click **"ðŸ”„ Regenerate Odds"** button on any game
2. All market odds recalculate based on base odds
3. Alert: "âœ… Odds regenerated successfully!"
4. Verify:
   - All market values update
   - Refresh page - new values persist
   - Other users see the regenerated odds

### 6. Test Pausing and Resuming Game

**Verify game state persists:**

1. On a live game, click **"â¸ï¸ Pause Game"** button
2. Game should show as paused
3. Click **"â–¶ï¸ Resume Game"** button
4. Game should resume playback
5. Verify:
   - Pause/Resume state persists after page refresh
   - Other users see the paused/resumed state in real-time

### 7. Test Ending Game

**Verify final status persists:**

1. Click **"ðŸ End Game"** button on a live game
2. Game status should change to "FINISHED"
3. Verify:
   - Status persists after page refresh
   - Other users see the game as finished
   - No more score updates possible (game is locked)

### 8. Test User Balance Editing

**Verify user balance updates persist:**

1. Go to the **"ðŸ‘¥ User Management"** tab
2. Find any user in the list
3. Click **"âœï¸ Edit User"** button
4. Edit the **"Account Balance (KSH)"** field
5. Change it to a different amount, e.g., from 5000 to 10000
6. Click **"ðŸ’¾ Save"** button
7. Alert: "âœ… User data updated successfully!"
8. Verify:
   - Balance updates in the user list
   - Refresh page - balance change persists
   - If you edited your own account balance:
     - Your balance shown on home page updates
     - Syncs across all your devices
   - Check another user's account - they see their updated balance

### 9. Test Activating Withdrawal

**Verify withdrawal activation persists:**

1. Go to the **"ðŸ‘¥ User Management"** tab
2. Find a user with **Withdrawal: Not Activated** status
3. Click **"ðŸ”“ Activate Withdrawal"** button
4. There's a 1.5s processing delay
5. Alert: "âœ… Withdrawal activated for [User Name]"
6. Verify:
   - Status changes to "Withdrawal: Activated"
   - Status persists after page refresh
   - Other user's account shows withdrawal as activated
   - User can now request withdrawals

### 10. Test Deleting a Game

**Verify game deletion persists:**

1. Find a test game you added
2. Click **"ðŸ—‘ï¸ Delete"** button
3. Confirm deletion in the alert
4. Game disappears from the list
5. Verify:
   - Refresh page - game is gone (not in database)
   - Other users don't see the deleted game
   - The game is permanently removed from bets/markets

## Data Persistence Verification

### Check Backend API Directly

Use browser console or API testing tool (curl, Postman):

```bash
# Get all games
curl https://server-tau-puce.vercel.app/api/admin/games

# Get admin stats
curl https://server-tau-puce.vercel.app/api/admin/stats
```

You should see the games and stats you just created/modified.

### Check Supabase Database Directly

1. Go to Supabase Dashboard
2. Navigate to your project
3. Go to **SQL Editor**
4. Run a query to verify data:

```sql
-- Check games added
SELECT game_id, home_team, away_team, status, created_at 
FROM games 
ORDER BY created_at DESC 
LIMIT 10;

-- Check admin logs
SELECT action, target_type, description, created_at 
FROM admin_logs 
ORDER BY created_at DESC 
LIMIT 10;

-- Check balance history
SELECT user_id, balance_before, balance_after, reason, created_at 
FROM balance_history 
ORDER BY created_at DESC 
LIMIT 5;
```

### Monitor Admin Logs

All admin actions are logged in the `admin_logs` table:
- Game creation, updates, deletions
- Score updates
- Market changes
- User balance adjustments
- Withdrawal activations
- Payment resolutions

Each log entry includes:
- Admin ID (who made the change)
- Action type
- Target type and ID
- Changes made
- Timestamp

## Common Test Scenarios

### Test 1: Real-Time Multi-User Sync

1. Open Admin Portal in your main browser
2. Open the same account on a second browser/incognito window
3. Add a game in browser 1
4. Switch to browser 2 and refresh the page
5. The game should appear in browser 2
6. Edit the game score in browser 1
7. Refresh browser 2 - score update appears

### Test 2: Non-Admin User Verification

1. Logout from admin account
2. Login with a regular user account
3. Go to the Matches or Betting page
4. All games added by admin should be visible
5. Update scores should be reflected in game display
6. Check that users cannot access `/muleiadmin` (should redirect or show error)

### Test 3: Data Integrity

1. Add a game with specific odds
2. Update the score multiple times
3. Refresh the page
4. Verify:
   - Game exists
   - Score is the latest value you set
   - Odds reflect the score adjustments
   - No missing or corrupted data

### Test 4: Error Handling

1. Try to update a game that was deleted
2. Try to add a game with empty fields
3. Try to access admin endpoints as non-admin user
4. Verify proper error messages are displayed

## Troubleshooting

### Game added but disappears after refresh

**Problem:** Game shows in UI but vanishes after page refresh
**Solution:** 
- Check browser console for errors (F12 > Console)
- Verify the backend API is responding: Check network tab
- Ensure admin is properly authenticated

### Score updates not showing for other users

**Problem:** You see the score update, but other users don't
**Solution:**
- Have other users refresh their page manually
- Check that the score update call succeeded (check network tab)
- Verify the game ID matches in database

### "Admin access required" error

**Problem:** Getting 403 error when trying to add game
**Solution:**
- Verify you're logged in as admin (0714945142)
- Check that the admin user exists and has is_admin=true in database
- Try logging out and logging back in
- Clear browser cache (Ctrl+Shift+Delete)

### Balance changes not syncing

**Problem:** Changed user balance but it doesn't update for that user
**Solution:**
- Refresh page to sync data
- Check balance_history table to verify change was logged
- Verify the balance update API call succeeded

## Success Criteria

âœ… All admin functions should:
1. Update the UI immediately (optimistic update)
2. Save to Supabase database
3. Persist after page refresh
4. Be visible to other logged-in users immediately (or after refresh)
5. Create audit logs in admin_logs table
6. Show confirmation alerts/messages

## Performance Notes

- Games load within 1-2 seconds
- Score updates save in <500ms
- Other APIs complete within 1-2 seconds
- Page refresh shows latest data immediately

## Next Steps After Testing

1. **If all tests pass:** Data persistence is working correctly
   - Users can now trust that admin changes are permanent
   - Withdraw the test games/data you created

2. **If any test fails:** 
   - Check the browser console (F12 > Console tab)
   - Check the network tab in DevTools
   - Review the backend logs in Vercel
   - Check Supabase logs for database errors

## Support

If you encounter issues:
1. Check the console error message
2. Verify the HTTP status code (200 = success, 401/403 = auth, 500 = server)
3. Check Vercel backend logs: vercel.com > select project > "Logs"
4. Check Supabase logs for database errors
5. Review server/routes/admin.routes.js for backend issues
